#!/bin/sh /etc/rc.common

START=99
USE_PROCD=1

# ä½ çš„ç¨‹åºè·¯å¾„
PROG=/usr/bin/sing-box
CONF=/etc/sing-box/config.json
# åˆšæ‰ä¿å­˜çš„é˜²ç«å¢™è„šæœ¬è·¯å¾„
NFT_SCRIPT=/etc/sing-box/nft-tproxy.sh

start_service() {
	procd_open_instance
	procd_set_param command "$PROG" run -c "$CONF"
	procd_set_param user root

	# è®¾ç½®èµ„æºé™åˆ¶ï¼ˆå¯é€‰ï¼Œé˜²æ­¢å†…å­˜æº¢å‡ºï¼‰
	procd_set_param limits core="unlimited"
	procd_set_param limits nofile="1048576 1048576"

	# è‡ªåŠ¨é‡å¯ï¼šå¦‚æœæŒ‚äº†ï¼Œå°è¯•é‡å¯
	procd_set_param respawn ${respawn_threshold:-3600} ${respawn_timeout:-5} ${respawn_retry:-5}

	# æ ‡å‡†è¾“å‡ºæ—¥å¿—ï¼ˆå¯é€‰ï¼‰
	procd_set_param stdout 1
	procd_set_param stderr 1
	procd_close_instance

	# â˜…â˜…â˜… é‡ç‚¹åœ¨è¿™é‡Œï¼å¯åŠ¨ååŠ è½½é˜²ç«å¢™è§„åˆ™ â˜…â˜…â˜…
	# ç­‰å¾…ä¸€ä¸‹ç¡®ä¿è¿›ç¨‹èµ·æ¥äº†ï¼ˆå¯é€‰ï¼Œé€šå¸¸ä¸éœ€è¦ï¼‰
	echo "ğŸ± Ava: Loading Sing-Box NFTables rules..."
	$NFT_SCRIPT
}

stop_service() {
	# â˜…â˜…â˜… é‡ç‚¹åœ¨è¿™é‡Œï¼åœæ­¢æ—¶æ¸…ç†é˜²ç«å¢™è§„åˆ™ â˜…â˜…â˜…
	# å¦‚æœä¸æ¸…ç†ï¼Œæµé‡ä¼šè¢«å¯¼å‘è™šç©ºï¼Œå¯¼è‡´æ–­ç½‘ï¼
	echo "ğŸ± Ava: Cleaning up Sing-Box NFTables rules..."
	nft delete table inet sing-box 2>/dev/null || true
}

# é¢å¤–çš„ reload å‡½æ•°ï¼Œç”¨äºé‡è½½é…ç½®æ—¶åˆ·æ–°è§„åˆ™
reload_service() {
	stop
	start
}
